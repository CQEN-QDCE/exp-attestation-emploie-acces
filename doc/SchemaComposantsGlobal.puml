@startuml ArchitectureGlobal
    
'Références graphique
!define AWSPuml https://raw.githubusercontent.com/awslabs/aws-icons-for-plantuml/master/dist

'Composants graphique
!includeurl AWSPuml/AWSSimplified.puml
!includeurl AWSPuml/General/MobileClient.puml
!includeurl AWSPuml/Blockchain/Blockchain.puml

'left to right direction

'**************
'DÉFINITION DES REGROUPEMENTS
'**************

rectangle "Controle d'accèss physique" {
    agent "RFID Reader" as reader
    agent "Micro Controller" as mcontrol
    agent ESP8266
    cloud Internet
    MobileClient(cellcf, "Portefeuille numérique", "appareil de l'employé") #LightBlue
    }

rectangle "Contrôle d'accèss virtuel"{
    agent Keycloak
    agent "http://" as URL
    agent "Access Denied" as Denied
    agent "Ressource protegé" as Protege
    agent Realm
    agent "Vérificateur /  ACA-Py" as Verifv
    MobileClient(cellcv, "Portefeuille numérique", "appareil de l'employé") #LightBlue
    }

rectangle "Gestionnaire d'accès" {
    agent "Vérification du courriel" as Emetteur
    actor "Gestionnaire d'accès" as Gestionnaire
    agent "Création du profil usager" as CProfile
    actor Employé as Employe
    agent "Agent mediateur" as AM
    agent "Boite eMail" as Boite
    agent "Agent ACA-Py" as ACAPYga
    database "DB" as DB #LightBlue
    MobileClient(cellga, "Portefeuille numérique", "appareil de l'employé") #LightBlue
    Blockchain(dltCA, "Blockchain CANdy", "Registre de confiance") #LightBlue
    }

agent "Agent Aca-Py" as 1acapy

'**************
'DÉFINITION DES LIENS
'**************

'LIENS DU CONTROLE D'ACCES PHYSIQUE
    cellcf --> reader : "Présente token"
    reader --> cellcf : "Demande token"
    reader -- mcontrol
    mcontrol -- ESP8266
    ESP8266 -- Internet


'LIENS DU CONTROLE D'ACCES VIRTUEL
cellcv --> Keycloak : "Présente preuve"
Keycloak --> cellcv : "Demande preuve"
Keycloak --> Denied
Keycloak <--> Protege
Keycloak <--> Realm
Keycloak <--> Verifv
URL --> Keycloak

'LIENS SANS REGROUPEMENT AU DROIT DU DIAGRAMME
Internet --> 1acapy
1acapy --> dltCA  : "Journalisation accès physique?"

'LIENS De l'ÉMETTEUR
Emetteur <--> ACAPYga
Emetteur -left-> DB
Gestionnaire -down-> CProfile : "0- Donner accès"
Employe -down-> Emetteur : "1-Saisir son courriel"
Emetteur -down-> Boite : "2-Envoyer lien à utilisation unique"
Employe -down-> Boite : "3 Lire courriel et clic sur lien unique "
Boite -up-> Emetteur : "4-Affichage du code à barre"
cellga -left-> Emetteur : "5-Lecture du code à barre"
cellga <--> AM : "6-Réception attestation d'accès 1/2"
AM <--> ACAPYga : "7-Réception attestation d'accès 2/2"
CProfile -right-> DB
dltCA <--> cellga
Verifv --> dltCA
AM <--> dltCA
ACAPYga <--> dltCA

@enduml